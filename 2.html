<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>POS ‚Äì Filter Sub-Kategori</title>

    <!-- Link ke stylesheet eksternal -->
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <!-- ===== HEADER ===== -->
      <header>
        <h1>Tutorial Peningkatan Filter Laporan Stok</h1>
        <p>
          Tutorial komprehensif ini memandu Anda dalam meningkatkan
          fungsionalitas Laporan Stok di Ultimate POS dengan menambahkan
          kemampuan penyaringan tingkat lanjut termasuk filter multi-pilihan
        </p>
      </header>

      <!-- ===== DOWNLOAD BUTTON ===== -->
      <div class="download-box">
        <!-- Ganti path & nama file sesuai berkas Anda -->
        <a
          href="https://drive.google.com/drive/folders/1xI7jT8QgGAN-JWw0lTb7YK663hGlWcla?usp=drive_link"
          download
          class="download-button"
        >
          ‚¨áÔ∏è Unduh File
        </a>
      </div>

      <!-- HOME -->
       <div class="home-button-wrapper">
          <a href="index.html" class="home-button">üè† Kembali ke Beranda</a>
        </div>

      <!-- ===== SECTIONS ===== -->
      <section>
        <h2>Gambaran Umum</h2>
        <h3>
          Peningkatan ini mengubah Laporan Stok standar menjadi alat penyaringan
          yang kuat dengan kemampuan multi-pilihan.
        </h3>
        <div class="image-box">
          <img
            src="https://ultimate-pos-tutorials.vercel.app/assets/images/stock-report-filter-enhancement-33d3ba7c4d6ac1109a4a659f17d45093.png"
            alt="#"
          />
          <p class="caption">
            Gambar: Tutorial Peningkatan Filter Laporan Stok.
          </p>
        </div>
        <h3>üì¶ Unduh File Starter</h3>
        <a href="https://drive.google.com/file/d/1dH0LWNBIbLHIasbboYe76wCEXivwbWj2/view?usp=drive_link" download class="section-download"
          >‚¨áÔ∏è Unduh</a
        >
      </section>

      <section>
        <h3>Apa yang Ditambah oleh Peningkatan Ini</h3>
        <ul>
          <li>
            Kemampuan multi-pilihan untuk semua filter yang ada (Lokasi,
            Kategori, Sub-kategori, Merek, Unit)
          </li>
          <li>
            Filter tingkat stok dengan opsi: Semua, Lebih Besar dari Nol, Kurang
            dari Satu
          </li>
          <li>
            Penanganan opsi "Semua" untuk pengalaman pengguna yang lebih baik
          </li>
          <li>
            Logika pemfilteran yang lebih baik untuk kinerja dan akurasi yang
            lebih baik
          </li>
        </ul>
        <h3>Manfaat</h3>
        <ul>
          <li>
            ‚úÖ Pemfilteran Multi-dimensi: Pilih beberapa kategori, merek, lokasi
            secara bersamaan
          </li>
          <li>
            ‚úÖ Pengalaman Pengguna yang lebih baik: Opsi "Semua" yang intuitif
            dan status filter yang jelas
          </li>
          <li>
            ‚úÖ Peningkatan Kinerja: Kueri basis data yang dioptimalkan untuk
            filter yang kompleks
          </li>
          <li>
            ‚úÖ Tampilan Mata Uang yang Tepat: Pemformatan yang konsisten dengan
            simbol mata uang
          </li>
        </ul>
      </section>
      <section>
        <h1>Langkah-langkah implementasi</h1>
      </section>
      <section>
        <h2>‚úÖ Langkah 1: Perbarui ReportController.php</h2>
        <h3>1.1 Menambahkan Metode getStockValue yang Disempurnakan</h3>
        <p>
          Ganti metode <code>getStockValue</code> yang sudah ada dengan versi
          yang disempurnakan ini:
        </p>
        <p>app/Http/Controllers/ReportController.php</p>

        <pre><code>
            /**
 * Enhanced getStockValue method for multi-select compatibility
 *
 * @param Request $request
 * @return \Illuminate\Http\JsonResponse
 */
public function getStockValue(Request $request)
{
    try {
        $business_id = $request->session()->get('user.business_id');
        $end_date = \Carbon::now()->format('Y-m-d');
        $permitted_locations = auth()->user()->permitted_locations();

        // Process filters using enhanced logic
        $filters = $this->processStockValueFilters($request);

        // Handle location_id separately for getOpeningClosingStock method
        $location_id = null;
        if (isset($filters['location_id'])) {
            $location_id = $filters['location_id'];
            unset($filters['location_id']); // Remove from filters array
        }

        // Get Closing stock by purchase price
        $closing_stock_by_pp = $this->transactionUtil->getOpeningClosingStock(
            $business_id,
            $end_date,
            $location_id,
            false, // is_opening = false
            false, // by_sale_price = false (by purchase price)
            $filters,
            $permitted_locations
        );

        // Get Closing stock by selling price
        $closing_stock_by_sp = $this->transactionUtil->getOpeningClosingStock(
            $business_id,
            $end_date,
            $location_id,
            false, // is_opening = false
            true,  // by_sale_price = true
            $filters,
            $permitted_locations
        );

        // Calculate potential profit and margin
        $potential_profit = $closing_stock_by_sp - $closing_stock_by_pp;
        $profit_margin = empty($closing_stock_by_sp) ? 0 : ($potential_profit / $closing_stock_by_sp) * 100;

        // Format the values using transactionUtil->num_f() with currency symbol
        $response = [
            'closing_stock_by_pp' => $this->transactionUtil->num_f($closing_stock_by_pp, true),
            'closing_stock_by_sp' => $this->transactionUtil->num_f($closing_stock_by_sp, true),
            'potential_profit' => $this->transactionUtil->num_f($potential_profit, true),
            'profit_margin' => number_format($profit_margin, 1),

            // Keep raw values for calculations if needed
            'raw_closing_stock_by_pp' => round($closing_stock_by_pp, 2),
            'raw_closing_stock_by_sp' => round($closing_stock_by_sp, 2),
            'raw_potential_profit' => round($potential_profit, 2),
            'raw_profit_margin' => round($profit_margin, 2),
        ];

        return response()->json($response);
    } catch (\Exception $e) {
        \Log::error('Error in getStockValue: ' . $e->getMessage());
        \Log::error('Stack trace: ' . $e->getTraceAsString());

        return response()->json([
            'closing_stock_by_pp' => $this->transactionUtil->num_f(0, true),
            'closing_stock_by_sp' => $this->transactionUtil->num_f(0, true),
            'potential_profit' => $this->transactionUtil->num_f(0, true),
            'profit_margin' => '0.0',
        ], 500);
    }
}
        </code></pre>

        <h3>1.2 Tambahkan metode processStockValueFilters</h3>
        <p>
          Tambahkan metode privat baru ini untuk menangani pemrosesan filter:
        </p>
        <p>app/Http/Controllers/ReportController.php</p>
        <pre><code>
            /**
 * Process stock value specific filters
 *
 * @param Request $request
 * @return array
 */
private function processStockValueFilters(Request $request)
{
    $filters = [];

    // Define filter mappings
    $filterMappings = [
        'location_id' => $request->input('location_id'),
        'category_id' => $request->input('category_id'),
        'sub_category_id' => $request->input('sub_category_id'),
        'brand_id' => $request->input('brand_id'),
        'unit_id' => $request->input('unit_id'),
        'stock_level' => $request->input('stock_level')
    ];

    foreach ($filterMappings as $key => $value) {
        if (!empty($value)) {
            if (is_array($value)) {
                // Remove empty values, null values, and "All" selections
                $value = array_filter($value, function ($v) {
                    return $v !== '' && $v !== null && trim($v) !== '' && $v !== 'null';
                });

                if (!empty($value)) {
                    if ($key === 'stock_level') {
                        // Stock level is not an array
                        $filters[$key] = reset($value);
                    } else {
                        // Convert to integers for ID fields, removing any zero values
                        $intValues = array_values(array_map('intval', $value));
                        $intValues = array_filter($intValues, function ($v) {
                            return $v > 0; // Only include positive integers
                        });

                        if (!empty($intValues)) {
                            $filters[$key] = $intValues;
                        }
                    }
                }
            } else {
                if (trim($value) !== '' && $value !== null) {
                    if (in_array($key, ['category_id', 'sub_category_id', 'brand_id', 'unit_id', 'location_id'])) {
                        $intValue = intval($value);
                        if ($intValue > 0) {
                            $filters[$key] = $intValue;
                        }
                    } else {
                        $filters[$key] = $value;
                    }
                }
            }
        }
    }

    return $filters;
}
        </code></pre>
        <h3>1.3 Perbarui Metode getStockReport</h3>
        <p>
          Perbarui metode <code>getStockReport</code> yang sudah ada untuk
          menyertakan pemrosesan filter yang disempurnakan:
        </p>
        <p>app/Http/Controllers/ReportController.php</p>
        <pre><code>
            /**
 * Shows product stock report with enhanced multi-select filtering
 *
 * @return \Illuminate\Http\Response
 */
public function getStockReport(Request $request)
{
    if (!auth()->user()->can('stock_report.view')) {
        abort(403, 'Unauthorized action.');
    }

    $business_id = $request->session()->get('user.business_id');

    // Check if manufacturing module is enabled
    $show_manufacturing_data = 0;
    if (
        $this->moduleUtil->isModuleInstalled('Manufacturing') &&
        (auth()->user()->can('superadmin') ||
            $this->moduleUtil->hasThePermissionInSubscription($business_id, 'manufacturing_module'))
    ) {
        $show_manufacturing_data = 1;
    }

    // Check selling price group permissions
    $selling_price_groups = SellingPriceGroup::where('business_id', $business_id)->get();
    $allowed_selling_price_group = false;
    foreach ($selling_price_groups as $selling_price_group) {
        if (auth()->user()->can('selling_price_group.' . $selling_price_group->id)) {
            $allowed_selling_price_group = true;
            break;
        }
    }

    if ($request->ajax()) {
        // Process enhanced multi-select filters
        $filters = $this->processEnhancedStockReportFilters($request);

        // Add manufacturing data flag
        $filters['show_manufacturing_data'] = $show_manufacturing_data;

        // Return the details in ajax call
        $for = $request->input('for') == 'view_product' ? 'view_product' : 'datatables';

        $products = $this->productUtil->getProductStockDetails($business_id, $filters, $for);

        // To show stock details on view product modal
        if ($for == 'view_product' && !empty($request->input('product_id'))) {
            $product_stock_details = $products;
            return view('product.partials.product_stock_details')->with(compact('product_stock_details'));
        }

        // Build DataTable with enhanced columns
        $datatable = Datatables::of($products)
            ->editColumn('stock', function ($row) {
                if ($row->enable_stock) {
                    $stock = $row->stock ? $row->stock : 0;
                    return '<span class="current_stock" data-orig-value="' . (float) $stock . '" data-unit="' . $row->unit . '"> ' .
                        $this->transactionUtil->num_f($stock, false, null, true) . '</span> ' . $row->unit;
                } else {
                    return '--';
                }
            })
            ->editColumn('product', function ($row) {
                $name = $row->product;
                return $name;
            })
            ->addColumn('action', function ($row) {
                return '<a class="tw-dw-btn tw-dw-btn-xs tw-dw-btn-outline tw-dw-btn-info tw-w-max" href="' .
                    action([\App\Http\Controllers\ProductController::class, 'productStockHistory'], [$row->product_id]) .
                    '?location_id=' . $row->location_id . '&variation_id=' . $row->variation_id .
                    '"><i class="fas fa-history"></i> ' . __('lang_v1.product_stock_history') . '</a>';
            })
            ->addColumn('variation', function ($row) {
                $variation = '';
                if ($row->type == 'variable') {
                    $variation .= $row->product_variation . '-' . $row->variation_name;
                }
                return $variation;
            })
            ->editColumn('total_sold', function ($row) {
                $total_sold = 0;
                if ($row->total_sold) {
                    $total_sold = (float) $row->total_sold;
                }
                return '<span data-is_quantity="true" class="total_sold" data-orig-value="' . $total_sold . '" data-unit="' . $row->unit . '" >' .
                    $this->transactionUtil->num_f($total_sold, false, null, true) . '</span> ' . $row->unit;
            })
            ->editColumn('total_transfered', function ($row) {
                $total_transfered = 0;
                if ($row->total_transfered) {
                    $total_transfered = (float) $row->total_transfered;
                }
                return '<span class="total_transfered" data-orig-value="' . $total_transfered . '" data-unit="' . $row->unit . '" >' .
                    $this->transactionUtil->num_f($total_transfered, false, null, true) . '</span> ' . $row->unit;
            })
            ->editColumn('total_adjusted', function ($row) {
                $total_adjusted = 0;
                if ($row->total_adjusted) {
                    $total_adjusted = (float) $row->total_adjusted;
                }
                return '<span class="total_adjusted" data-orig-value="' . $total_adjusted . '" data-unit="' . $row->unit . '" >' .
                    $this->transactionUtil->num_f($total_adjusted, false, null, true) . '</span> ' . $row->unit;
            })
            ->editColumn('unit_price', function ($row) use ($allowed_selling_price_group) {
                $html = '';
                if (auth()->user()->can('access_default_selling_price')) {
                    $html .= $this->transactionUtil->num_f($row->unit_price, true);
                }

                if ($allowed_selling_price_group) {
                    $html .= ' <button type="button" class="tw-dw-btn tw-dw-btn-xs tw-dw-btn-outline tw-dw-btn-primary tw-w-max btn-modal no-print" data-container=".view_modal" data-href="' .
                        action([\App\Http\Controllers\ProductController::class, 'viewGroupPrice'], [$row->product_id]) . '">' .
                        __('lang_v1.view_group_prices') . '</button>';
                }

                return $html;
            })
            ->editColumn('stock_price', function ($row) {
                $html = '<span class="total_stock_price" data-orig-value="' . $row->stock_price . '">' .
                    $this->transactionUtil->num_f($row->stock_price, true) . '</span>';
                return $html;
            })
            ->editColumn('stock_value_by_sale_price', function ($row) {
                $stock = $row->stock ? $row->stock : 0;
                $unit_selling_price = (float) $row->group_price > 0 ? $row->group_price : $row->unit_price;
                $stock_price = $stock * $unit_selling_price;

                return '<span class="stock_value_by_sale_price" data-orig-value="' . (float) $stock_price . '" > ' .
                    $this->transactionUtil->num_f($stock_price, true) . '</span>';
            })
            ->addColumn('potential_profit', function ($row) {
                $stock = $row->stock ? $row->stock : 0;
                $unit_selling_price = (float) $row->group_price > 0 ? $row->group_price : $row->unit_price;
                $stock_price_by_sp = $stock * $unit_selling_price;
                $potential_profit = (float) $stock_price_by_sp - (float) $row->stock_price;

                return '<span class="potential_profit" data-orig-value="' . (float) $potential_profit . '" > ' .
                    $this->transactionUtil->num_f($potential_profit, true) . '</span>';
            })
            ->setRowClass(function ($row) {
                return $row->enable_stock && $row->stock <= $row->alert_quantity ? 'bg-danger' : '';
            })
            ->filterColumn('variation', function ($query, $keyword) {
                $query->whereRaw("CONCAT(COALESCE(pv.name, ''), '-', COALESCE(variations.name, '')) like ?", ["%{$keyword}%"]);
            })
            ->filterColumn('stock', function ($query, $keyword) {
                if (request('stock_level') == 'gt_zero') {
                    $query->having('stock', '>', 0);
                } elseif (request('stock_level') == 'lt_one') {
                    $query->having('stock', '<=', 0);
                }
            })
            ->removeColumn('enable_stock')
            ->removeColumn('unit')
            ->removeColumn('id');

        $raw_columns = [
            'unit_price',
            'total_transfered',
            'total_sold',
            'total_adjusted',
            'stock',
            'stock_price',
            'stock_value_by_sale_price',
            'potential_profit',
            'action',
        ];

        // Add manufacturing columns if enabled
        if ($show_manufacturing_data) {
            $datatable->editColumn('total_mfg_stock', function ($row) {
                $total_mfg_stock = 0;
                if ($row->total_mfg_stock) {
                    $total_mfg_stock = (float) $row->total_mfg_stock;
                }

                return '<span data-is_quantity="true" class="total_mfg_stock" data-orig-value="' . $total_mfg_stock . '" data-unit="' . $row->unit . '" >' .
                    $this->transactionUtil->num_f($total_mfg_stock, false, null, true) . '</span> ' . $row->unit;
            });
            $raw_columns[] = 'total_mfg_stock';
        }

        return $datatable->rawColumns($raw_columns)->make(true);
    }

    // Prepare data for the view
    $categories = Category::forDropdown($business_id, 'product');
    $brands = Brands::forDropdown($business_id);
    $units = Unit::where('business_id', $business_id)->pluck('short_name', 'id');
    $business_locations = BusinessLocation::forDropdown($business_id, true);

    return view('report.stock_report')->with(compact(
        'categories',
        'brands',
        'units',
        'business_locations',
        'show_manufacturing_data'
    ));
}
        </code></pre>

        <h3>1.4 Tambahkan metode processEnhancedStockReportFilters</h3>
        <p>
          Tambahkan metode ini untuk menangani pemfilteran laporan stok yang
          disempurnakan:
        </p>

        <p>app/Http/Controllers/ReportController.php</p>
        <pre><code>
            /**
 * Process enhanced multi-select filters for stock report
 *
 * @param Request $request
 * @return array
 */
private function processEnhancedStockReportFilters(Request $request)
{
    // Get all possible filters
    $filters = $request->only([
        'location_id',
        'category_id',
        'sub_category_id',
        'brand_id',
        'unit_id',
        'tax_id',
        'type',
        'only_mfg_products',
        'active_state',
        'not_for_selling',
        'repair_model_id',
        'product_id',
        'stock_level'
    ]);

    // Multi-select filters that need special processing
    $multiSelectFilters = ['location_id', 'category_id', 'sub_category_id', 'brand_id', 'unit_id'];

    foreach ($multiSelectFilters as $filter) {
        if (isset($filters[$filter])) {
            // Handle different input formats
            if (is_string($filters[$filter])) {
                // Handle comma-separated strings
                $filters[$filter] = explode(',', $filters[$filter]);
            }

            // Ensure it's an array
            if (!is_array($filters[$filter])) {
                $filters[$filter] = [$filters[$filter]];
            }

            // Remove empty values, null values, and "All" selections ('')
            $filters[$filter] = array_filter($filters[$filter], function ($value) {
                return $value !== '' && $value !== null && $value !== '0' && trim($value) !== '';
            });

            // If no valid values remain, remove the filter (means "All")
            if (empty($filters[$filter])) {
                unset($filters[$filter]);
            } else {
                // Re-index array and convert to proper types
                $filters[$filter] = array_values(array_map('intval', $filters[$filter]));
            }
        }
    }

    // Handle boolean and special filters
    $filters['not_for_selling'] = isset($filters['not_for_selling']) &&
        ($filters['not_for_selling'] == 'true' || $filters['not_for_selling'] == '1') ? 1 : 0;

    $filters['only_mfg_products'] = isset($filters['only_mfg_products']) &&
        ($filters['only_mfg_products'] == '1' || $filters['only_mfg_products'] === true) ? 1 : 0;

    // Handle stock level filter
    if (isset($filters['stock_level']) && empty(trim($filters['stock_level']))) {
        unset($filters['stock_level']);
    }

    // Handle active state
    if (isset($filters['active_state']) && empty(trim($filters['active_state']))) {
        unset($filters['active_state']);
    }

    // Handle type filter
    if (isset($filters['type']) && empty(trim($filters['type']))) {
        unset($filters['type']);
    }

    // Remove any remaining empty or null values
    $filters = array_filter($filters, function ($value) {
        if (is_array($value)) {
            return !empty($value);
        }
        return $value !== '' && $value !== null;
    });

    return $filters;
}
        </code></pre>
      </section>

      <section>
        <h2>‚úÖ Langkah 2: Perbarui TransactionUtil.php</h2>
        <p>
          Perbarui metode <code>getOpeningClosingStock</code> Anda untuk
          mendukung filter multi-pilihan:
        </p>

        <p>app/Utils/TransactionUtil.php</p>
        <pre><code>
            public function getOpeningClosingStock($business_id, $date, $location_id, $is_opening = false, $by_sale_price = false, $filters = [], $permitted_locations = null)
{
    $query = PurchaseLine::join(
        'transactions as purchase',
        'purchase_lines.transaction_id',
        '=',
        'purchase.id'
    )
        ->where('purchase.type', '!=', 'purchase_order')
        ->where('purchase.business_id', $business_id);

    $price_query_part = '(purchase_lines.purchase_price +
                    COALESCE(purchase_lines.item_tax, 0))';

    if ($by_sale_price) {
        $price_query_part = 'v.sell_price_inc_tax';
    }

    $query->leftjoin('variations as v', 'v.id', '=', 'purchase_lines.variation_id')
        ->leftjoin('products as p', 'p.id', '=', 'purchase_lines.product_id');

    // Handle multi-select filters
    if (!empty($filters['category_id'])) {
        if (is_array($filters['category_id'])) {
            $query->whereIn('p.category_id', $filters['category_id']);
        } else {
            $query->where('p.category_id', $filters['category_id']);
        }
    }

    if (!empty($filters['sub_category_id'])) {
        if (is_array($filters['sub_category_id'])) {
            $query->whereIn('p.sub_category_id', $filters['sub_category_id']);
        } else {
            $query->where('p.sub_category_id', $filters['sub_category_id']);
        }
    }

    if (!empty($filters['brand_id'])) {
        if (is_array($filters['brand_id'])) {
            $query->whereIn('p.brand_id', $filters['brand_id']);
        } else {
            $query->where('p.brand_id', $filters['brand_id']);
        }
    }

    if (!empty($filters['unit_id'])) {
        if (is_array($filters['unit_id'])) {
            $query->whereIn('p.unit_id', $filters['unit_id']);
        } else {
            $query->where('p.unit_id', $filters['unit_id']);
        }
    }

    if (!empty($filters['user_id'])) {
        $query->where('purchase.created_by', $filters['user_id']);
    }

    //If opening
    if ($is_opening) {
        $next_day = \Carbon::createFromFormat('Y-m-d', $date)->addDay()->format('Y-m-d');

        $query->where(function ($query) use ($date, $next_day) {
            $query->whereRaw("date(transaction_date) <= '$date'")
                ->orWhereRaw("date(transaction_date) = '$next_day' AND purchase.type='opening_stock' ");
        });
    } else {
        $query->whereRaw("date(transaction_date) <= '$date'");
    }

    $query->select(
        DB::raw("SUM((purchase_lines.quantity - purchase_lines.quantity_returned - purchase_lines.quantity_adjusted -
                    (SELECT COALESCE(SUM(tspl.quantity - tspl.qty_returned), 0) FROM
                    transaction_sell_lines_purchase_lines AS tspl
                    JOIN transaction_sell_lines as tsl ON
                    tspl.sell_line_id=tsl.id
                    JOIN transactions as sale ON
                    tsl.transaction_id=sale.id
                    WHERE tspl.purchase_line_id = purchase_lines.id AND
                    date(sale.transaction_date) <= '$date') ) * $price_query_part
                ) as stock")
    );

    //Check for permitted locations of a user
    if (!empty($permitted_locations)) {
        if ($permitted_locations != 'all') {
            $query->whereIn('purchase.location_id', $permitted_locations);
        }
    }

    // Updated location_id handling to support arrays
    if (!empty($location_id)) {
        if (is_array($location_id)) {
            // Handle multiple locations
            $query->whereIn('purchase.location_id', $location_id);
        } else {
            // Original code for a single location
            $query->where('purchase.location_id', $location_id);
        }
    }

    $details = $query->first();

    return $details->stock;
}
        </code></pre>
      </section>

      <section>
        <h2>‚úÖ Langkah 3: Perbarui Tampilan Blade</h2>
        <p>
          Ganti file
          <code>resources/views/report/stock_report.blade.php</code> Anda dengan
          versi yang telah disempurnakan ini:
        </p>

        <p>resources/views/report/stock_report.blade.php</p>
        <a href="downloads/section2.html" download class="section-download"
          >‚¨áÔ∏è Unduh</a
        >
      </section>

      <section>
        <h2>‚úÖ Langkah 4: Perbarui public/js/report.js</h2>
        <p>
          Perbarui file <code>public/js/report.js</code> Anda untuk menyertakan
          filter tingkat stok dalam konfigurasi DataTable dan ubah
          penanganannya.
        </p>

        <h3>4.1 Menambahkan Level Stok ke Konfigurasi Tabel Data</h3>
        <p>
          Temukan inisialisasi Tabel Data <code>stock_report_table</code> Anda
          dan tambahkan parameter level stok:
        </p>

        <p>public/js/report.js</p>
        <pre><code>
            stock_report_table = $('#stock_report_table').DataTable({
    // ... existing configuration
    ajax: {
        url: '/reports/stock-report',
        data: function (d) {
            // ... existing parameters
            d.stock_level = $('#stock_level').val();
            // ... other parameters
        },
    },
    // ... rest of configuration
});
        </code></pre>
        <h3>4.2 Perbarui Penangan Perubahan Filter</h3>
        <p>
          Perbarui penangan peristiwa perubahan untuk menyertakan filter tingkat
          stok:
        </p>

        <p>public/js/report.js</p>
        <pre><code>
            $(
    '#stock_report_filter_form #location_id, #stock_report_filter_form #category_id, #stock_report_filter_form #sub_category_id, #stock_report_filter_form #brand, #stock_report_filter_form #unit, #stock_report_filter_form #stock_level, #stock_report_filter_form #view_stock_filter'
).change(function () {
    stock_report_table.ajax.reload();
    stock_expiry_report_table.ajax.reload();
    get_stock_value();
});
        </code></pre>
      </section>

      <section>
        <h2>
          ‚úÖ Langkah 5: Menambahkan Metode Subkategori ke ProductController
        </h2>
        <p>
          Jika Anda belum memiliki metode ini, tambahkan metode tersebut ke
          ProductController Anda untuk menangani pemuatan subkategori dinamis:
        </p>
        <h3>5.1 Menambahkan Metode getSubKategori</h3>
        <p>app/Http/Controllers/ProductController.php</p>
        <pre><code>
            /**
 * Get subcategories based on selected categories
 */
public function getSubCategories(Request $request)
{
    if (request()->ajax()) {
        $term = request()->input('term', '');
        $cat_id = request()->input('cat_id', '');

        $business_id = request()->session()->get('user.business_id');

        $sub_categories = Category::where('business_id', $business_id)
            ->where('category_type', 'product');

        if (!empty($cat_id)) {
            $sub_categories->where('parent_id', $cat_id);
        }

        if (!empty($term)) {
            $sub_categories->where('name', 'like', '%' . $term . '%');
        }

        $sub_categories = $sub_categories->select('name', 'short_code', 'id')
            ->get();

        return json_encode($sub_categories);
    }
}
        </code></pre>

        <h3>5.2 Menambahkan metode getSubCategoriesMulti</h3>
        <p>app/Http/Controllers/ProductController.php</p>
        <pre><code>
            /**
 * Get subcategories for multiple selected categories
 */
public function getSubCategoriesMulti(Request $request)
{
    if (request()->ajax()) {
        $cat_ids = request()->input('cat_ids', []);
        $business_id = request()->session()->get('user.business_id');

        if (empty($cat_ids)) {
            return response()->json([]);
        }

        $sub_categories = Category::where('business_id', $business_id)
            ->where('category_type', 'product')
            ->whereIn('parent_id', $cat_ids)
            ->pluck('name', 'id')
            ->toArray();

        return response()->json($sub_categories);
    }
}
        </code></pre>

        <h3>5.3 Menambahkan Rute untuk Metode Subkategori</h3>
        <p>
          Tambahkan rute-rute ini ke <code>routes/web.php</code> Anda jika belum
          ada:
        </p>

        <p>routes/web.php</p>
        <pre><code>
            Route::get('/products/get-sub-categories', [\App\Http\Controllers\ProductController::class, 'getSubCategories']);
            Route::post('/products/get_sub_categories_multi', [\App\Http\Controllers\ProductController::class, 'getSubCategoriesMulti']);
        </code></pre>
      </section>

      <section>
        <h2>üß™ Fitur-fitur Utama</h2>
        <h3>Kemampuan Multi-Pilihan</h3>
        <ul>
          <li>
            <strong>Beberapa Lokasi</strong>: Saring berdasarkan beberapa lokasi
            bisnis secara bersamaan
          </li>
          <li>
            <strong>Beberapa Kategori</strong>: Pilih beberapa kategori produk
          </li>
          <li>
            <strong>Beberapa Merek</strong>: Saring berdasarkan beberapa merek
            sekaligus
          </li>
          <li>
            <strong>Beberapa Unit</strong>: Memfilter berdasarkan jenis unit
            yang berbeda
          </li>
        </ul>

        <h3>Tampilan Nilai stok yang Ditingkatkan</h3>
        <ul>
          <li>
            <strong>Nilai Harga Beli</strong>: Total nilai saham pada harga beli
          </li>
          <li>
            <strong>Nilai Harga Jual</strong>: Total nilai saham pada harga jual
          </li>
          <li>
            <strong>Potensi Keuntungan</strong>: Selisih antara nilai penjualan
            dan pembelian
          </li>
          <li>
            <strong>Margin Keuntungan</strong>: Persentase margin keuntungan
            dengan format yang tepat
          </li>
        </ul>

        <h3>Penanganan Kesalahan yang Kuat</h3>
        <ul>
          <li>
            <strong>Manajemen Kesalahan AJAX</strong>: Penanganan kesalahan yang
            lembut untuk masalah jaringan
          </li>
          <li>
            <strong>Validasi Filter</strong>: Validasi yang tepat untuk input
            filter
          </li>
          <li>
            <strong>Tampilan Mata Uang</strong>: Pemformatan mata uang yang
            konsisten di semua nilai
          </li>
        </ul>
      </section>

      <section>
        <h2>üõ†Ô∏è Manfaatnya</h2>
        <ul>
          <li>
            <strong>Pengalaman Pengguna yang lebih baik</strong>: Antarmuka
            multi-pilihan yang intuitif dengan opsi yang jelas
          </li>
          <li>
            <strong>Analisis Data yang lebih baik</strong>: Pemfilteran berbagai
            dimensi untuk wawasan yang komprehensif
          </li>
          <li>
            <strong>Pemformatan yang Konsisten</strong>: Tampilan mata uang yang
            tepat dengan simbol khusus bisnis
          </li>
          <li>
            <strong>Kinerja yang Ditingkatkan</strong>: Kueri yang dioptimalkan
            untuk filter multi-pilihan
          </li>
          <li>
            <strong>Kode yang Dapat Dipelihara</strong>: Kode yang bersih dan
            terstruktur dengan baik mengikuti praktik terbaik Laravel
          </li>
        </ul>
        <div class="danger">
          Peningkatan ini secara signifikan meningkatkan kemampuan pelaporan
          stok dengan tetap mempertahankan kompatibilitas ke belakang dan
          mengikuti pola yang sudah ada di aplikasi POS Anda.
        </div>
      </section>

      <footer>
        <div class="home-button-wrapper">
          <a href="index.html" class="home-button">üè† Kembali ke Beranda</a>
        </div>
      </footer>
    </div>
  </body>
</html>
